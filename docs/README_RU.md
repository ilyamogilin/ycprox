# ycprox

Инструмент для развёртывания forward-прокси в инфраструктуре Yandex Cloud для смены IP-адреса (почти) при каждом запросе.

## Возможности
- Поддержка всех HTTP(S) методов
- Проксирование всех параметров и URI
- Подмена заголовка X-Forwarded-For через заголовок X-My-X-Forwarded-For (спасибо [fireprox](https://github.com/ustayready/fireprox/) за идею!)
- Ротация IP-адреса (почти) при каждом запросе (требует дополнительного тестирования)

## Как это работает

ycprox, подобно [fireprox](https://github.com/ustayready/fireprox/), создаёт API Gateway в облаке, но дополнительно разворачивает Cloud Function для очищениения заголовков, добавляемых API Gateway по умолчанию (это поведение нельзя переопределить).

```
Клиент → API Gateway → Cloud Function → Хост целевого сервиса
```

Прокси сохраняет заголовки, передаваемые параметры и тело запроса, фильтруя внутренние заголовки Yandex Cloud.

## Требования

- Python >= 3.11
- (опционально) пакетный менеджер [uv](https://docs.astral.sh/uv/) или отдельный virtualenv
- Аккаунт Yandex Cloud с созданным облаком и каталогом (можно использовать дефолтные)

## Быстрый старт

```bash
# Клонируем репозиторий
git clone https://github.com/chlzen/ycprox.git
cd ycprox

# Опционально: создаем venv
# python -m venv ycproxenv
# source ycproxenv/bin/activate

# Устанавливаем через pip
pip install .

# Аутентифицируемся с Yandex OAuth токеном
ycprox auth init

# Разворачиваем прокси в каталоге be4dfadewdlksjedde 
# Скопируйте folder id из консоли Yandex Cloud
ycprox proxy up --url https://example-service.com --folder-id be4dfadewdlksjedde

# Смотрим информацию о прокси
ycprox proxy info

# Обращаемся к прокси
curl "https://kekkekkekkek.lmao.apigw.yandexcloud.net/"

# Удаляем прокси
ycprox proxy down
```

## Команды

### Аутентификация

| Команда | Описание |
|---------|----------|
| `ycprox auth init` | Получить Yandex OAuth токен и сохранить в локальное хранилище |
| `ycprox auth reset` | Удалить сохранённый OAuth токен из хранилища |

### Управление прокси

`ycprox proxy up`

Развернуть прокси в Yandex Cloud.

| Опция | Обязательно | По умолчанию | Описание |
|-------|-------------|--------------|----------|
| `--url` | Да | — | URL целевого сервиса для проксирования запросов |
| `--folder-id` | Да | — | ID каталога Yandex Cloud для развёртывания ресурсов |
| `--gw-name` | Нет | `ycprox-gateway` | Имя API Gateway |
| `--cf-name` | Нет | `ycprox-function` | Имя Cloud Function |

`ycprox proxy info`

Показать информацию о текущем прокси.

`ycprox proxy down`

Удалить прокси из облака.

## Переменные окружения (опционально)

Все переменные окружения используют префикс `YCPROX_`. Также можно использовать файл `.env` в рабочей директории.

| Переменная | Описание | По умолчанию |
|------------|----------|--------------|
| `YCPROX_UA_STRING` | Кастомный User-Agent для API запросов | `ycprox/{version}` |

## Дисклеймер
- В данный момент ycprox поддерживает **только одно развёртывание прокси одновременно**
- Использование этого инструмента на системах, которыми вы не владеете, вероятно нарушает [Условия использования сервисов платформы Yandex Cloud](https://yandex.ru/legal/cloud_termsofuse/) и может привести к блокировке или приостановке вашего аккаунта Yandex Cloud. Более того, даже использование этого инструмента на системах, которыми вы владеете или имеете явное разрешение на проведение тестирования на проникновение, регулируется [Политикой допустимого использования сервисов платформы Yandex Cloud](https://yandex.ru/legal/cloud_aup/).
- Это программное обеспечение предоставляется «как есть», без каких-либо гарантий, и вы используете его на свой страх и риск
